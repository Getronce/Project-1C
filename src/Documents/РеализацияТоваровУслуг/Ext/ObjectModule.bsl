Процедура ОбработкаПроведения(Отказ, Режим)
	СообщенияОбОшибках = Новый Массив;
	
	ЗапросОстатки = Новый Запрос;
	ЗапросОстатки.Текст = 
	"ВЫБРАТЬ
	|	ТоварыДокумента.Номенклатура,
	|	ТоварыДокумента.Количество,
	|	ЕСТЬNULL(Остатки.КоличествоОстаток, 0) КАК КоличествоОстаток
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК ТоварыДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(&МоментВремени, Склад = &Склад) КАК Остатки
	|		ПО Остатки.Номенклатура = ТоварыДокумента.Номенклатура
	|ГДЕ
	|	ТоварыДокумента.Ссылка = &Ссылка
	|	И ТоварыДокумента.Номенклатура.ТипНоменклатуры <> &Услуга";
	
	МоментВремениГраницы = Новый Граница(МоментВремени(), ВидГраницы.Включая);
	ЗапросОстатки.УстановитьПараметр("МоментВремени", МоментВремениГраницы);
	ЗапросОстатки.УстановитьПараметр("Склад", Склад);
	ЗапросОстатки.УстановитьПараметр("Ссылка", Ссылка);
	ЗапросОстатки.УстановитьПараметр("Услуга", Перечисления.ТипыНоменклатуры.Услуга);
	
	Результат = ЗапросОстатки.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ТекущийОстаток = Выборка.КоличествоОстаток;
		ОстатокПослеПроведения = ТекущийОстаток - Выборка.Количество;
		
		Если ОстатокПослеПроведения < 0 Тогда
			Нехватка = -ОстатокПослеПроведения;
			Сообщение = "На складе " + Склад.Наименование + " не хватает " + 
			           Выборка.Номенклатура.Наименование + 
			           " в количестве " + Формат(Нехватка, "ЧДЦ=0") + " шт.";
			СообщенияОбОшибках.Добавить(Сообщение);
		КонецЕсли;
	КонецЦикла;
	
	Если СообщенияОбОшибках.Количество() > 0 Тогда
		Отказ = Истина;
		
		//ТекстСообщения = "Нельзя провести документ из-за недостаточного количества товаров на складе:" + Символы.ПС;
		//Для Каждого Сообщение Из СообщенияОбОшибках Цикл
		//	ТекстСообщения = ТекстСообщения + Сообщение + Символы.ПС;
		//КонецЦикла;
		ТекстСообщения = СтрСоединить(СообщенияОбОшибках, Символы.ПС);
		
		Сообщить(ТекстСообщения, СтатусСообщения.Важное);
		Возврат;	
	КонецЕсли;
	
	//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	//Движения.ТоварыНаСкладах.Очистить();
	//Движения.Продажи.Очистить();
	// регистр ТоварыНаСкладах Расход
	Движения.ТоварыНаСкладах.Записывать = Истина;
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		Движение = Движения.ТоварыНаСкладах.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Склад = Склад;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.Количество = ТекСтрокаТовары.Количество;
	КонецЦикла;

	// регистр Продажи 
	Движения.Продажи.Записывать = Истина;
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		Движение = Движения.Продажи.Добавить();
		Движение.Период = Дата;
		Движение.Менеджер = Менеджер;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.Сумма = ТекСтрокаТовары.Сумма;
		Движение.Количество = ТекСтрокаТовары.Количество
	КонецЦикла;

	//}КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ	
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	СуммаДокумента = Товары.Итог("Сумма");
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	//{{__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		// Заполнение шапки
		Контрагент = ДанныеЗаполнения.Контрагент;
		Менеджер = ДанныеЗаполнения.Менеджер;
		Склад = ДанныеЗаполнения.Склад;
		ДокументОснование = ДанныеЗаполнения.Ссылка;
		СуммаДокумента = ДанныеЗаполнения.СуммаДокумента;
		Статус = Перечисления.СтатусыОтгрузки.Зарезервировано;
		Для Каждого ТекСтрокаТовары Из ДанныеЗаполнения.Товары Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.Количество = ТекСтрокаТовары.Количество;
			НоваяСтрока.Номенклатура = ТекСтрокаТовары.Номенклатура;
			НоваяСтрока.Сумма = ТекСтрокаТовары.Сумма;
			НоваяСтрока.Цена = ТекСтрокаТовары.Цена;
		КонецЦикла;
	КонецЕсли;
	//}}__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
КонецПроцедуры

